<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>随机文章复习工具</title>
    <style>
        /* 简单的 CSS 样式 (保持不变) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f8f8;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007aff;
            font-size: 24px;
            text-align: center;
            margin-bottom: 20px;
        }
        .markdown-content {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            min-height: 200px;
            line-height: 1.6;
        }
        .markdown-content h1, .markdown-content h2 {
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-top: 20px;
        }
        .markdown-content pre {
            background-color: #f6f8fa;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
        }
        .action-bar {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .action-bar button {
            flex-grow: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: #007aff;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .action-bar button:hover {
            background-color: #005bb5;
        }
        /* 加载指示器样式 */
        #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: #007aff;
            z-index: 1000;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 id="article-title">随机文章复习工具</h1>
        
        <div id="article-view" class="markdown-content">
            <p>正在加载配置，请稍候...</p>
        </div>

        <div class="action-bar">
            <button id="next-article-btn" onclick="fetchAndDisplayRandomArticle()" disabled>获取下一篇随机文章</button>
        </div>
    </div>
    
    <div id="loading-indicator">
        正在加载...
    </div>

    <script>
        // ======================================================
        // Web 实现 JavaScript 逻辑
        // ======================================================

        // --- 配置区域 ---
        const GITHUB_BASE_URL = "https://raw.githubusercontent.com/losymear/cognition/main/memo/";
        // 新的配置 JSON 文件 URL
        const CONFIG_URL = "https://raw.githubusercontent.com/losymear/cognition/main/files/json/config.json";

        // ARTICLE_COUNT 现在是一个动态变量
        let ARTICLE_COUNT = 0;

        // --- DOM 元素引用 ---
        const articleTitle = document.getElementById('article-title');
        const articleView = document.getElementById('article-view');
        const loadingIndicator = document.getElementById('loading-indicator');
        const nextArticleBtn = document.getElementById('next-article-btn');

        // --- 核心辅助函数 (适应 Web) ---

        function setLoading(isLoading) {
            loadingIndicator.style.display = isLoading ? 'flex' : 'none';
        }

        function webAlert(title, message) {
            console.error(`${title}: ${message}`);
            alert(`${title}\n\n${message}`);
        }
        
        // --- 1. 读取配置函数 ---

        async function loadConfig() {
            setLoading(true);
            try {
                const resp = await fetch(CONFIG_URL);
                
                if (!resp.ok) {
                    throw new Error(`无法获取配置：${resp.status}`);
                }

                const config = await resp.json();
                
                if (typeof config.maxMemoId !== 'number' || config.maxMemoId < 1) {
                    throw new Error(`配置格式错误或 maxMemoId 小于 1。`);
                }

                ARTICLE_COUNT = config.maxMemoId;
                
                // 配置加载成功，启用按钮并更新提示
                nextArticleBtn.disabled = false;
                articleView.innerHTML = `<p>配置加载成功！当前文章总数 (maxMemoId) 为：**${ARTICLE_COUNT}**。</p><p>点击下方按钮开始随机复习。</p>`;
                
                setLoading(false);
                return true;

            } catch (error) {
                setLoading(false);
                webAlert("配置加载失败", `无法从 ${CONFIG_URL} 读取 maxMemoId。请检查网络或配置格式。\n错误信息: ${error.message}`);
                nextArticleBtn.disabled = true;
                articleView.innerHTML = `<p style="color: red;">配置加载失败，请刷新重试。</p>`;
                return false;
            }
        }

        // --- 2. 获取文章函数 ---

        async function fetchAndDisplayRandomArticle() {
            if (ARTICLE_COUNT < 1) {
                webAlert("错误", "文章数量配置无效，请刷新页面重新加载配置。");
                return;
            }

            // 1. 随机生成文件编号 (1 到 ARTICLE_COUNT)
            let randomFileNumber = Math.floor(Math.random() * ARTICLE_COUNT) + 1;
            let fileName = `${randomFileNumber}.md`;
            let fullUrl = GITHUB_BASE_URL + fileName;
            
            console.log(`尝试获取: ${fullUrl}`);

            // 2. 获取文件内容
            setLoading(true);

            try {
                const resp = await fetch(fullUrl);
                
                setLoading(false);

                if (!resp.ok) {
                    webAlert("网络错误", `无法获取文件：${fileName} (状态码: ${resp.status})。请检查 URL 或文件是否存在。`);
                    return;
                }

                let articleContent = await resp.text();
                
                // 检查内容是否为空或异常
                if (articleContent.length < 10) { // 降低检查标准，避免误判
                    webAlert("文件内容异常", `随机选取的文章 ${fileName} 内容过短或为空。`);
                    return;
                }
                
                // 3. 渲染主页面视图
                renderArticleView(randomFileNumber, articleContent);

            } catch (error) {
                setLoading(false);
                webAlert("网络请求失败", `在请求 ${fullUrl} 时发生错误：${error.message}`);
            }
        }

        /**
         * 渲染文章视图（适应 Web DOM）
         */
        function renderArticleView(articleNum, content) {
            articleTitle.textContent = `复习文章 ${articleNum}.md`;

            // 使用 marked.js 将 Markdown 转换为 HTML
            const renderedHtml = marked.parse(content);

            // 将 HTML 插入到文章内容区域
            articleView.innerHTML = renderedHtml;
        }

        // --- 脚本主流程 ---

        // 脚本启动时，首先加载配置
        loadConfig();
    </script>
</body>
</html>
